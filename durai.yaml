
# Esphome config to connect a Duracell Durai Inverter into homeassistant
# Should also work with similar CYG Skyline based inverters such as the MidNite AIO 
# The register maps where taken from https://github.com/iPeel/HA-Skyline/tree/main
# and supplemented by an AI search.
# My thanks goes out to iPeel who created the above project.
#
# This project requires an ESP32 and a low cost RS232 to RS485 adapter
# 
# A Liligo LILYGO T-CAN485 or a Waveshare ESP32-S3-RS485-CAN should work but may need the UART pins changed
esphome:
  name: durai_inverter
  friendly_name: Durai_Inverter

esp32:
  framework:
    type: esp-idf
  board: esp32dev

# Enable Home Assistant API
api:
  encryption:
    key: "YOUR-KEY"

ota:
  - platform: esphome
    password: "YOUR-PASSWORD"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Durai Fallback Hotspot"
    password: "YOUR_BACKUP-PASSWORD"

captive_portal:

web_server:

logger:
  level: VERBOSE

# UART configuration for RS485
uart:
  id: uart_1
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 9600
  data_bits: 8
  parity: NONE
  stop_bits: 1

# Required for total_daily_energy.
time:
  - platform: sntp

# MODBUS client over UART.
modbus:
  id: mod_bus
  uart_id: uart_1
  role: client


modbus_controller:
  - id: skyline
    address: 0x1
    modbus_id: mod_bus
    setup_priority: -10
# Setting a lower update_value may cause issues with the phone app/cloud sync
# This could be improved by block reading the registers rather than individually but thats for another time
    update_interval: 10s

sensor:
  # WiFi Signal Strength
  - platform: wifi_signal
    name: "WiFi Signal Sensor"
    update_interval: 60s

  # System uptime
  - platform: uptime
    name: "Uptime Sensor"


  # System Temperature
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Inverter Temperature"
    id: system_temp
    register_type: holding
    address: 0x101A
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 0
    value_type: S_WORD


  # Grid Power Sensors (0x1300 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Power"
    id: grid_power
    register_type: holding
    address: 0x1300
    register_count: 2
    response_size: 4
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.0001

  # Grid Energy In Total
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Energy In Total"
    id: grid_energy_in_total
    register_type: holding
    address: 0x1306
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Grid Energy Out Total
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Energy Out Total"
    id: grid_energy_out_total
    register_type: holding
    address: 0x1308
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Grid Tied Load
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Current Load"
    id: grid_tied_load
    register_type: holding
    address: 0x130A
    register_count: 2
    response_size: 4
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.0001

  # Grid Voltage
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Voltage"
    id: grid_voltage
    register_type: holding
    address: 0x131A
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Grid Current
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Current"
    id: grid_current
    register_type: holding
    address: 0x131D
    register_count: 2
    response_size: 4
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.01

  # Grid Energy In Today
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Energy In Today"
    id: grid_energy_in_today
    register_type: holding
    address: 0x1332
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Grid Energy Out Today
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Energy Out Today"
    skip_updates: 10
    id: grid_energy_out_today
    register_type: holding
    address: 0x1334
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # EPS Sensors (0x1350 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "EPS Load L1"
    id: eps_load_l1
    register_type: holding
    address: 0x1353
    internal: true
    register_count: 2
    response_size: 4
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.0001


  # Total EPS Load (template sensor)
  - platform: template
    name: "EPS Load"
    id: eps_load
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    lambda: |-
      return id(eps_load_l1).state;  
# Three phase inverter
#      return id(eps_load_l1).state + id(eps_load_l2).state + id(eps_load_l3).state;

  # Battery Sensors (0x2000 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "State of Charge"
    id: soc
    register_type: holding
    address: 0x2000
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    accuracy_decimals: 0

  # Battery Voltage
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Voltage"
    id: battery_voltage
    register_type: holding
    address: 0x2006
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Battery Current
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Current"
    id: battery_current
    register_type: holding
    address: 0x2007
    register_count: 2
    response_size: 4
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    value_type: S_DWORD
    filters:
      - multiply: 0.01

  # Battery Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Load"
    id: battery_load
    register_type: holding
    address: 0x2009
    register_count: 2
    response_size: 4
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.0001

  # Battery Energy In Today
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Energy In Today"
    skip_updates: 10
    id: battery_energy_in_today
    register_type: holding
    address: 0x200B
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Battery Energy In Total
  - platform: modbus_controller
    modbus_controller_id: skyline
    skip_updates: 10
    name: "Bat Energy In Total"
    id: battery_energy_in_total
    register_type: holding
    address: 0x200D
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Battery Energy Out Today
  - platform: modbus_controller
    modbus_controller_id: skyline
    skip_updates: 10
    name: "Bat Energy Out Today"
    id: battery_energy_out_today
    register_type: holding
    address: 0x200F
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Battery Energy Out Total
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Energy Out Total"
    skip_updates: 10
    id: battery_energy_out_total
    register_type: holding
    address: 0x2011
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 2
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "MPPT1 Power"
    id: mppt1_power_correct
    register_type: holding
    address: 0x1012
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1



  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "MPPT2 Power"
    id: mppt2_power_correct
    register_type: holding
    address: 0x1016
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: template
    name: 'Current PV Energy'
    id: pv_current
    lambda: |-
      return (id(mppt1_power_correct).state + id(mppt2_power_correct).state);
    unit_of_measurement: 'kWh'
    device_class: energy
    accuracy_decimals: 1
    filters:
      # Multiplication factor from W to kW is 0.001
      - multiply: 0.001


  - platform: total_daily_energy
    name: 'Total Daily PV Energy'
    power_id: pv_current
    unit_of_measurement: 'kWh'
    state_class: total_increasing
    device_class: energy
    accuracy_decimals: 1
    filters:
      - multiply: 0.001       # Multiplication factor from W to kW is 0.001



  # Inner Temperature (correct address)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Inverter Temp"
    skip_updates: 5
    id: inner_temp
    register_type: holding
    address: 0x101C
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 0
    value_type: S_WORD

  # Inverter Mode
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Inverter Mode"
    skip_updates: 10
    id: inverter_mode
    register_type: holding
    address: 0x101D
    state_class: measurement
    accuracy_decimals: 0



  # Total Generation Time
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Total Generation Time"
    skip_updates: 10
    id: total_generation_time
    register_type: holding
    address: 0x1023
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "h"
    state_class: measurement
    accuracy_decimals: 0

  # Today Energy (Wh)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Today Energy Wh"
    id: today_energy_wh
    skip_updates: 10
    register_type: holding
    address: 0x1027
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0

  # Active Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Active Power"
    id: active_power
    skip_updates: 10
    register_type: holding
    address: 0x1037
    register_count: 2
    response_size: 4
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1


  # Today Peak Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Today Peak Power"
    id: today_peak_power
    skip_updates: 10
    register_type: holding
    address: 0x103B
    register_count: 2
    response_size: 4
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1



  # Accumulated Load Energy
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Accum Load Energy"
    id: accumulated_load_energy
    skip_updates: 10
    register_type: holding
    address: 0x1310
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    filters:
      - multiply: 10

  # Today Load Energy
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Today Load Energy"
    skip_updates: 10
    id: today_load_energy
    register_type: holding
    address: 0x1336
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    filters:
      - multiply: 10

  # Grid Frequency
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Frequency"
    id: grid_frequency
    register_type: holding
    address: 0x1338
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 2
    filters:
      - multiply: 0.01


  # Daily and Accumulated EPS Energy
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Daily EPS Energy"
    id: daily_eps_energy
    skip_updates: 10
    register_type: holding
    address: 0x1360
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    filters:
      - multiply: 10

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Accum EPS Energy"
    id: accumulated_eps_energy
    skip_updates: 10
    register_type: holding
    address: 0x1362
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    filters:
      - multiply: 10

  # Additional device information sensors
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "MPPT Number"
    skip_updates: 10
    entity_category: diagnostic
    id: mppt_number
    register_type: holding
    address: 0x1A3B
    state_class: measurement
    accuracy_decimals: 0

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Rated Voltage"
    entity_category: diagnostic
    id: rated_voltage
    skip_updates: 10
    register_type: holding
    address: 0x1A44
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Rated Frequency"
    entity_category: diagnostic
    id: rated_frequency
    skip_updates: 10
    register_type: holding
    address: 0x1A45
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 0
    filters:
      - multiply: 0.01

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Rated Power"
    entity_category: diagnostic
    id: rated_power
    skip_updates: 10
    register_type: holding
    address: 0x1A46
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Phase Number"
    entity_category: diagnostic
    skip_updates: 10
    id: grid_phase_number
    register_type: holding
    address: 0x1A48
    state_class: measurement
    accuracy_decimals: 0


text_sensor:
  # Device model information (0x1A00 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Model Number"
    entity_category: diagnostic
    id: model_number
    skip_updates: 20
    register_type: holding
    address: 0x1A00
    register_count: 8
    response_size: 16
    raw_encode: HEXBYTES

  # Device serial information (0x1A10 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Serial Number"
    entity_category: diagnostic
    skip_updates: 20
    id: serial_number
    register_type: holding
    address: 0x1A10
    register_count: 8
    response_size: 16
    raw_encode: HEXBYTES

  # Master software version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Master Software Version"
    skip_updates: 20
    entity_category: diagnostic
    id: master_software_version
    register_type: holding
    address: 0x1A1C
    register_count: 3
    response_size: 6
    raw_encode: HEXBYTES

  # Slave software version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Slave Software Version"
    entity_category: diagnostic
    id: slave_software_version
    skip_updates: 20
    register_type: holding
    address: 0x1A26
    register_count: 3
    response_size: 6
    raw_encode: HEXBYTES

  # EMS software version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "EMS SW Ver"
    entity_category: diagnostic
    id: ems_software_version
    skip_updates: 20
    register_type: holding
    address: 0x1A60
    register_count: 3
    response_size: 6
    raw_encode: HEXBYTES

  # DCDC software version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "DCDC SW Ver"
    entity_category: diagnostic
    id: dcdc_software_version
    skip_updates: 20
    register_type: holding
    address: 0x1A6F
    register_count: 3
    response_size: 6
    raw_encode: HEXBYTES

  # Additional Device Information from Protocol
  # Modbus Protocol Version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Modbus Protocol Version"
    entity_category: diagnostic
    id: modbus_protocol_version
    skip_updates: 20
    register_type: holding
    address: 0x1A18
    raw_encode: HEXBYTES

  # Master Software Build Date
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Master Software Build Date"
    entity_category: diagnostic
    id: master_software_build_date
    skip_updates: 20
    register_type: holding
    address: 0x1A23
    register_count: 3
    response_size: 6
    raw_encode: HEXBYTES

  # Slave firmware build date
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Slave FW Date"
    entity_category: diagnostic
    id: slave_firmware_build_date
    skip_updates: 20
    register_type: holding
    address: 0x1A2D
    register_count: 3
    response_size: 6
    raw_encode: HEXBYTES

  # EMS Firmware build date
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "EMS FW Date"
    entity_category: diagnostic
    id: ems_firmware_build_date
    skip_updates: 20
    register_type: holding
    address: 0x1A67
    register_count: 7
    response_size: 14
    raw_encode: HEXBYTES

  # DCDC firmware build date
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "DCDC FW Date"
    entity_category: diagnostic
    id: dcdc_firmware_build_date
    skip_updates: 20
    register_type: holding
    address: 0x1A76
    register_count: 3
    response_size: 6
    raw_encode: HEXBYTES

# Binary sensors for grid status
binary_sensor:
  - platform: template
    name: "Grid Importing"
    id: grid_importing
    lambda: |-
      if (id(grid_power).state > 0.1) {
        return true;
      } else {
        return false;
      }

  - platform: template
    name: "Grid Exporting"
    id: grid_exporting
    lambda: |-
      if (id(grid_power).state < -0.1) {
        return true;
      } else {
        return false;
      }

number:
  # Time-based control parameters
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Charge Start Time 1 Hour"
    id: charge_start_time_1_hour
    skip_updates: 10
    register_type: holding
    address: 0x2102
#    min_value: 0
#    max_value: 23
#    step: 1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Charge Start Time 1 Minute"
    id: charge_start_time_1_minute
    register_type: holding
    address: 0x2102
 #   min_value: 0
 #   max_value: 59
 #   step: 1
    entity_category: config
    # Note: This should be byte manipulation for high/low bytes

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Charge End Time 1 Hour"
    id: charge_end_time_1_hour
    skip_updates: 10
    register_type: holding
    address: 0x2103
#    min_value: 0
#    max_value: 23
#    step: 1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Discharge Start Time 1 Hour"
    id: discharge_start_time_1_hour
    skip_updates: 10
    register_type: holding
    address: 0x2104
 #   min_value: 0
 #   max_value: 23
 #   step: 1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Discharge End Time 1 Hour"
    id: discharge_end_time_1_hour
    skip_updates: 10
    register_type: holding
    address: 0x2105
  #  min_value: 0
  #  max_value: 23
  #  step: 1
    entity_category: config


  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Battery Ah Capacity"
    id: battery_ah_capacity
    skip_updates: 10
    register_type: holding
    address: 0x2112
#    min_value: 50
#    max_value: 1000
#    step: 10
    unit_of_measurement: "Ah"
    device_class: power
    entity_category: config


  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Charge End SOC"
    id: grid_charge_end_soc
    skip_updates: 10
    register_type: holding
    address: 0x2117
#    min_value: 10
#    max_value: 100
#    step: 1
    unit_of_measurement: "%"
    device_class: battery
    entity_category: config

  # Grid and charger parameters
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Max Grid Chrge Pwr"
    id: maximum_grid_charger_power
    skip_updates: 10
    register_type: holding
    address: 0x2116
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"
    device_class: power
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Maximum Charger Power"
    id: maximum_charger_power
    skip_updates: 10
    register_type: holding
    address: 0x2118
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"
    device_class: power
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Maximum Discharger Power"
    id: maximum_discharger_power
    skip_updates: 10
    register_type: holding
    address: 0x211A
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"
    device_class: power
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Charger End SOC"
    id: charger_end_soc
    skip_updates: 10
    register_type: holding
    address: 0x2119
#    min_value: 10
#    max_value: 100
#    step: 1
    unit_of_measurement: "%"
    device_class: battery
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Discharger End SOC"
    id: discharger_end_soc
    skip_updates: 10
    register_type: holding
    address: 0x211B
#    min_value: 10
#    max_value: 90
#    step: 1
    unit_of_measurement: "%"
    device_class: battery
    entity_category: config


  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Max Feed-In Grid Pwr"
    id: maximum_feed_in_grid_power
    skip_updates: 10
    register_type: holding
    address: 0x30B9
    value_type: U_DWORD
#    min_value: 0
#    max_value: 10000
#    step: 100
    unit_of_measurement: "W"
    device_class: power
    entity_category: config

   # Battery Max SoC
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Max SoC"
    skip_updates: 10
    id: battery_max_soc
    register_type: holding
    address: 0x2119
#    min_value: 10
#    max_value: 100
#    step: 1

  # Grid Max Charge SoC
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Max Chrg SoC"
    skip_updates: 10
    id: grid_max_charge_soc
    register_type: holding
    address: 0x2117
#    min_value: 10
#    max_value: 100
#    step: 1

  # Grid Max Charge Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Max Chrg Power"
    skip_updates: 10
    id: grid_max_charge_power
    register_type: holding
    address: 0x2116
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"

  # Battery Max Charge Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Max Chg PWR"
    skip_updates: 10
    id: battery_max_charge_power
    register_type: holding
    address: 0x2118
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"

  # Battery Max Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Max Pwr"
    skip_updates: 10
    id: battery_max_power
    register_type: holding
    address: 0x211A
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"

  # Grid Max Feed In Power (0x30B0 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Max Feed-In"
    skip_updates: 10
    id: grid_max_feed_in_power
    register_type: holding
    address: 0x30BA
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"


select:
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Hybrid Work Mode"
    id: hybrid_work_mode
    address: 0x2100
    entity_category: config
    skip_updates: 10
    optionsmap:
      "Self Use Mode": 0
      "Grid-Feed-In-Mode": 1
      "Time Based Control": 2
      "Backup Mode": 3
      "Battery Discharge Mode": 4

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Charge Enable"
    skip_updates: 10
    id: grid_charge_enable
    address: 0x2115
    entity_category: config
    optionsmap:
      "Disable": 0
      "Enable": 1

switch:
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "EPS Enabled"
    skip_updates: 10
    id: eps_enabled
    register_type: holding
    address: 0x211C
    entity_category: config

# Status LED
status_led:
  pin:
    number: GPIO2
