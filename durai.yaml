
# Esphome config to connect a Duracell Durai Inverter into homeassistant
# Should also work with similar CYG Skyline based inverters such as the MidNite AIO 
# The register maps where taken from https://github.com/iPeel/HA-Skyline/tree/main
# and supplemented by an AI search.
# My thanks goes out to iPeel who created the above project.
#
# This project requires an ESP32 and a low cost RS232 to RS485 adapter
# 
# If using a Waveshare ESP32-S3-RS485-CAN module use the waveshare-esp32-s3-rs485.yaml file
esphome:
  name: durai_inverter
  friendly_name: Durai_Inverter

esp32:
  framework:
    type: esp-idf
  board: esp32dev

# Enable Home Assistant API
api:
  encryption:
    key: "YOUR-KEY"

ota:
  - platform: esphome
    password: "YOUR-PASSWORD"

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Durai Fallback Hotspot"
    password: "YOUR_BACKUP-PASSWORD"

captive_portal:

web_server:

logger:
  level: VERBOSE

# UART configuration for RS485
uart:
  id: uart_1
  tx_pin: GPIO17
  rx_pin: GPIO16
  baud_rate: 9600
  data_bits: 8
  parity: NONE
  stop_bits: 1

# Required for total_daily_energy.
time:
  - platform: sntp

# MODBUS client over UART.
modbus:
  id: mod_bus
  uart_id: uart_1
  role: client


modbus_controller:
  - id: skyline
    address: 0x1
    modbus_id: mod_bus
    setup_priority: -10
# Setting a lower update_value may cause issues with the phone app/cloud sync
# This could be improved by block reading the registers rather than individually but thats for another time
    update_interval: 10s

sensor:
  # WiFi Signal Strength
  - platform: wifi_signal
    name: "WiFi Signal Sensor"
    update_interval: 60s

  # System uptime
  - platform: uptime
    name: "Uptime Sensor"


    # System Temperature
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Inverter Temperature"
    id: system_temp
    register_type: holding
    address: 0x101A
    unit_of_measurement: "Â°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 0
    value_type: S_WORD


  # Grid Power Sensors (0x1300 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Power"
    id: grid_power
    register_type: holding
    address: 0x1300
    register_count: 2
    response_size: 4
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.0001

  # Grid Energy In Total
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Total Grid Energy In"
    id: grid_energy_in_total
    register_type: holding
    address: 0x1306
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Grid Energy Out Total
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Total Grid Energy Out"
    id: grid_energy_out_total
    register_type: holding
    address: 0x1308
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Grid Tied Load
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Current Load"
    id: grid_tied_load
    register_type: holding
    address: 0x130A
    register_count: 2
    response_size: 4
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.0001

  # Grid Voltage
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Voltage"
    id: grid_voltage
    register_type: holding
    address: 0x131A
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  # Grid Current
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Current"
    id: grid_current
    register_type: holding
    address: 0x131D
    register_count: 2
    response_size: 4
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.01

  # Grid Energy In Today
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Energy In Today"
    id: grid_energy_in_today
    register_type: holding
    address: 0x1332
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Grid Energy Out Today
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Energy Out Today"
    skip_updates: 10
    id: grid_energy_out_today
    register_type: holding
    address: 0x1334
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # EPS Sensors (0x1350 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "EPS Load L1"
    id: eps_load_l1
    register_type: holding
    address: 0x1353
    internal: true
    register_count: 2
    response_size: 4
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.0001


  # Total EPS Load (template sensor)
  - platform: template
    name: "EPS Load"
    id: eps_load
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    lambda: |-
      return id(eps_load_l1).state;  
# Three phase inverter
#      return id(eps_load_l1).state + id(eps_load_l2).state + id(eps_load_l3).state;

  # Battery Sensors (0x2000 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Battery SoC"
    id: soc
    register_type: holding
    address: 0x2000
    unit_of_measurement: "%"
    device_class: battery
    state_class: measurement
    accuracy_decimals: 0

  # Battery Voltage
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Voltage"
    id: battery_voltage
    register_type: holding
    address: 0x2006
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  # Battery Current
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Current"
    id: battery_current
    register_type: holding
    address: 0x2007
    register_count: 2
    response_size: 4
    unit_of_measurement: "A"
    device_class: current
    state_class: measurement
    accuracy_decimals: 1
    value_type: S_DWORD
    filters:
      - multiply: 0.01

  # Battery Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Load"
    id: battery_load
    register_type: holding
    address: 0x2009
    register_count: 2
    response_size: 4
    unit_of_measurement: "kW"
    device_class: power
    state_class: measurement
    accuracy_decimals: 2
    value_type: S_DWORD
    filters:
      - multiply: 0.0001

  # Battery Energy In Today
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat In Today"
    skip_updates: 10
    id: battery_energy_in_today
    register_type: holding
    address: 0x200B
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Battery Energy In Total
  - platform: modbus_controller
    modbus_controller_id: skyline
    skip_updates: 10
    name: "Bat In Total"
    id: battery_energy_in_total
    register_type: holding
    address: 0x200D
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Battery Energy Out Today
  - platform: modbus_controller
    modbus_controller_id: skyline
    skip_updates: 10
    name: "Bat Out Today"
    id: battery_energy_out_today
    register_type: holding
    address: 0x200F
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  # Battery Energy Out Total
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Out Total"
    skip_updates: 10
    id: battery_energy_out_total
    register_type: holding
    address: 0x2011
    register_count: 2
    response_size: 4
    unit_of_measurement: "kWh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    value_type: U_DWORD
    filters:
      - multiply: 0.01

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "MPPT1 Power"
    id: mppt1_power_correct
    register_type: holding
    address: 0x1012
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1



  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "MPPT2 Power"
    id: mppt2_power_correct
    register_type: holding
    address: 0x1016
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1

  - platform: template
    name: 'Current PV Energy'
    id: pv_current
    lambda: |-
      return (id(mppt1_power_correct).state + id(mppt2_power_correct).state);
    unit_of_measurement: 'kWh'
    device_class: energy
    accuracy_decimals: 1
    filters:
      # Multiplication factor from W to kW is 0.001
      - multiply: 0.001


  - platform: total_daily_energy
    name: 'Total Daily PV Energy'
    power_id: pv_current
    unit_of_measurement: 'kWh'
    state_class: total_increasing
    device_class: energy
    accuracy_decimals: 1
    filters:
      - multiply: 0.001       # Multiplication factor from W to kW is 0.001



  # Inner Temperature (correct address)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Inverter Temp"
    skip_updates: 5
    id: inner_temp
    register_type: holding
    address: 0x101C
    unit_of_measurement: "Â°C"
    device_class: temperature
    state_class: measurement
    accuracy_decimals: 0
    value_type: S_WORD




  # Total Generation Time
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Total Generation Time"
    skip_updates: 10
    id: total_generation_time
    register_type: holding
    address: 0x1023
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "h"
    state_class: measurement
    accuracy_decimals: 0

  # Today Energy (Wh)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Today Energy Wh"
    id: today_energy_wh
    skip_updates: 10
    register_type: holding
    address: 0x1027
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0

  # Active Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Active Power"
    id: active_power
    skip_updates: 10
    register_type: holding
    address: 0x1037
    register_count: 2
    response_size: 4
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.1


  # Today Peak Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Today Peak Power"
    id: today_peak_power
    skip_updates: 10
    register_type: holding
    address: 0x103B
    register_count: 2
    response_size: 4
    value_type: S_DWORD
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0
    filters:
      - multiply: 0.1



  # Accumulated Load Energy
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Total Accum Load Energy"
    id: accumulated_load_energy
    skip_updates: 10
    register_type: holding
    address: 0x1310
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    filters:
      - multiply: 0.01

  # Today Load Energy
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Today Load Energy"
    skip_updates: 10
    id: today_load_energy
    register_type: holding
    address: 0x1336
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    filters:
      - multiply: 10

  # Grid Frequency
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Frequency"
    id: grid_frequency
    register_type: holding
    address: 0x1338
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 1
    filters:
      - multiply: 0.01


  # Daily and Accumulated EPS Energy
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Total Daily EPS"
    id: daily_eps_energy
    skip_updates: 10
    register_type: holding
    address: 0x1360 # in 10Wh
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    filters:
      - multiply: 10

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Total EPS Energy"
    id: accumulated_eps_energy
    skip_updates: 10
    register_type: holding
    address: 0x1362  # in 10Wh
    register_count: 2
    response_size: 4
    value_type: U_DWORD
    unit_of_measurement: "Wh"
    device_class: energy
    state_class: total_increasing
    accuracy_decimals: 0
    filters:
      - multiply: 10

  # Additional device information sensors
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "MPPT Number"
    skip_updates: 10
    entity_category: diagnostic
    id: mppt_number
    register_type: holding
    address: 0x1A3B
    state_class: measurement
    accuracy_decimals: 0

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Rated Voltage"
    entity_category: diagnostic
    id: rated_voltage
    skip_updates: 10
    register_type: holding
    address: 0x1A44
    unit_of_measurement: "V"
    device_class: voltage
    state_class: measurement
    accuracy_decimals: 0
    filters:
      - multiply: 0.1

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Rated Frequency"
    entity_category: diagnostic
    id: rated_frequency
    skip_updates: 10
    register_type: holding
    address: 0x1A45
    unit_of_measurement: "Hz"
    device_class: frequency
    state_class: measurement
    accuracy_decimals: 0
    filters:
      - multiply: 0.01

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Rated Power"
    entity_category: diagnostic
    id: rated_power
    skip_updates: 10
    register_type: holding
    address: 0x1A46
    unit_of_measurement: "W"
    device_class: power
    state_class: measurement
    accuracy_decimals: 0

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Phase Number"
    entity_category: diagnostic
    skip_updates: 10
    id: grid_phase_number
    register_type: holding
    address: 0x1A48
    state_class: measurement
    accuracy_decimals: 0


text_sensor:

  # Inverter Mode
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Inverter Mode"
    skip_updates: 10
    id: inverter_mode
    register_type: holding
    address: 0x101D
    raw_encode: HEXBYTES
    lambda: |-
      uint16_t value = modbus_controller::word_from_hex_str(x, 0);
      switch (value) {
        case 0x00: return std::string("Initial mode");
        case 0x01: return std::string("Standby mode");
        case 0x03: return std::string("On Grid mode");
        case 0x04: return std::string("OffGrid mode");
        case 0x05: return std::string("Fault mode");
        case 0x09: return std::string("Shutdown mode");
        default: return std::string("Unknown");
      }
      return x;


  # Device model information (0x1A00 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Model Number"
    entity_category: diagnostic
    id: model_number
    skip_updates: 20
    register_type: holding
    address: 0x1A00
    register_count: 8
    response_size: 16
    raw_encode: ANSI 

  # Device serial information (0x1A10 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Serial Number"
    entity_category: diagnostic
    skip_updates: 20
    id: serial_number
    register_type: holding
    address: 0x1A10
    register_count: 8
    response_size: 16
    raw_encode: ANSI 

  # Master software version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Master Software Version"
    skip_updates: 20
    entity_category: diagnostic
    id: master_software_version
    register_type: holding
    address: 0x1A1C
    register_count: 3
    response_size: 6
    raw_encode: ANSI 

  # Slave software version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Slave Software Version"
    entity_category: diagnostic
    id: slave_software_version
    skip_updates: 20
    register_type: holding
    address: 0x1A26
    register_count: 3
    response_size: 6
    raw_encode: ANSI 

  # EMS software version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "EMS SW Ver"
    entity_category: diagnostic
    id: ems_software_version
    skip_updates: 20
    register_type: holding
    address: 0x1A60
    register_count: 3
    response_size: 6
    raw_encode: ANSI 

  # DCDC software version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "DCDC SW Ver"
    entity_category: diagnostic
    id: dcdc_software_version
    skip_updates: 20
    register_type: holding
    address: 0x1A6F
    register_count: 3
    response_size: 6
    raw_encode: ANSI 

  # Additional Device Information from Protocol
  # Modbus Protocol Version
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Modbus Protocol Version"
    entity_category: diagnostic
    id: modbus_protocol_version
    skip_updates: 20
    register_type: holding
    address: 0x1A18
    raw_encode: HEXBYTES 

  # Master Software Build Date
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Master Software Build Date"
    entity_category: diagnostic
    id: master_software_build_date
    skip_updates: 20
    register_type: holding
    address: 0x1A23
    register_count: 3
    response_size: 6
    raw_encode: ANSI 

  # Slave firmware build date
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Slave FW Date"
    entity_category: diagnostic
    id: slave_firmware_build_date
    skip_updates: 20
    register_type: holding
    address: 0x1A2D
    register_count: 3
    response_size: 6
    raw_encode: ANSI

  # EMS Firmware build date
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "EMS FW Date"
    entity_category: diagnostic
    id: ems_firmware_build_date
    skip_updates: 20
    register_type: holding
    address: 0x1A67
    register_count: 7
    response_size: 14
    raw_encode: ANSI

  # DCDC firmware build date
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "DCDC FW Date"
    entity_category: diagnostic
    id: dcdc_firmware_build_date
    skip_updates: 20
    register_type: holding
    address: 0x1A76
    register_count: 3
    response_size: 6
    raw_encode: ANSI

# Binary sensors for grid status
binary_sensor:
  - platform: template
    name: "Grid Importing"
    id: grid_importing
    lambda: |-
      if (id(grid_power).state > 0.1) {
        return true;
      } else {
        return false;
      }

  - platform: template
    name: "Grid Exporting"
    id: grid_exporting
    lambda: |-
      if (id(grid_power).state < -0.1) {
        return true;
      } else {
        return false;
      }

number:
  # Time-based control parameters
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Charge Start Time 1 Hour"
    id: charge_start_time_1_hour
    skip_updates: 10
    register_type: holding
    address: 0x2102
#    min_value: 0
#    max_value: 23
#    step: 1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Charge Start Time 1 Minute"
    id: charge_start_time_1_minute
    register_type: holding
    address: 0x2102
 #   min_value: 0
 #   max_value: 59
 #   step: 1
    entity_category: config
    # Note: This should be byte manipulation for high/low bytes

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Charge End Time 1 Hour"
    id: charge_end_time_1_hour
    skip_updates: 10
    register_type: holding
    address: 0x2103
#    min_value: 0
#    max_value: 23
#    step: 1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Discharge Start Time 1 Hour"
    id: discharge_start_time_1_hour
    skip_updates: 10
    register_type: holding
    address: 0x2104
 #   min_value: 0
 #   max_value: 23
 #   step: 1
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Discharge End Time 1 Hour"
    id: discharge_end_time_1_hour
    skip_updates: 10
    register_type: holding
    address: 0x2105
  #  min_value: 0
  #  max_value: 23
  #  step: 1
    entity_category: config


  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Battery Ah Capacity"
    id: battery_ah_capacity
    skip_updates: 10
    register_type: holding
    address: 0x2112
#    min_value: 50
#    max_value: 1000
#    step: 10
    unit_of_measurement: "Ah"
    device_class: power
    entity_category: config


  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Charge End SOC"
    id: grid_charge_end_soc
    skip_updates: 10
    register_type: holding
    address: 0x2117
#    min_value: 10
#    max_value: 100
#    step: 1
    unit_of_measurement: "%"
    device_class: battery
    entity_category: config

  # Grid and charger parameters
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Max Grid Chrge Pwr"
    id: maximum_grid_charger_power
    skip_updates: 10
    register_type: holding
    address: 0x2116
    min_value: 0
    max_value: {rated_power}
    step: 50
    unit_of_measurement: "W"
    device_class: power
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Maximum Charger Power"
    id: maximum_charger_power
    skip_updates: 10
    register_type: holding
    address: 0x2118
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"
    device_class: power
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Maximum Discharger Power"
    id: maximum_discharger_power
    skip_updates: 10
    register_type: holding
    address: 0x211A
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"
    device_class: power
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Charger End SOC"
    id: charger_end_soc
    skip_updates: 10
    register_type: holding
    address: 0x2119
#    min_value: 10
#    max_value: 100
#    step: 1
    unit_of_measurement: "%"
    device_class: battery
    entity_category: config

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Discharger End SOC"
    id: discharger_end_soc
    skip_updates: 10
    register_type: holding
    address: 0x211B
#    min_value: 10
#    max_value: 90
#    step: 1
    unit_of_measurement: "%"
    device_class: battery
    entity_category: config


  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Max Feed-In Grid Pwr"
    id: maximum_feed_in_grid_power
    skip_updates: 10
    register_type: holding
    address: 0x30B9
    value_type: U_DWORD
#    min_value: 0
#    max_value: 10000
#    step: 100
    unit_of_measurement: "W"
    device_class: power
    entity_category: config

   # Battery Max SoC
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Max SoC"
    skip_updates: 10
    id: battery_max_soc
    register_type: holding
    address: 0x2119
#    min_value: 10
#    max_value: 100
#    step: 1

  # Grid Max Charge SoC
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Max Chrg SoC"
    skip_updates: 10
    id: grid_max_charge_soc
    register_type: holding
    address: 0x2117
#    min_value: 10
#    max_value: 100
#    step: 1

  # Grid Max Charge Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Max Chrg Power"
    skip_updates: 10
    id: grid_max_charge_power
    register_type: holding
    address: 0x2116
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"

  # Battery Max Charge Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Max Chg PWR"
    skip_updates: 10
    id: battery_max_charge_power
    register_type: holding
    address: 0x2118
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"

  # Battery Max Power
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Bat Max Pwr"
    skip_updates: 10
    id: battery_max_power
    register_type: holding
    address: 0x211A
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"

  # Grid Max Feed In Power (0x30B0 range)
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Max Feed-In"
    skip_updates: 10
    id: grid_max_feed_in_power
    register_type: holding
    address: 0x30BA
#    min_value: 0
#    max_value: 6000
#    step: 50
    unit_of_measurement: "W"


select:
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Hybrid Work Mode"
    id: hybrid_work_mode
    address: 0x2100
    entity_category: config
    skip_updates: 10
    optionsmap:
      "Self Use Mode": 0
      "Grid-Feed-In-Mode": 1
      "Time Based Control": 2
      "Backup Mode": 3
      "Battery Discharge Mode": 4

  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "Grid Charge Enable"
    skip_updates: 10
    id: grid_charge_enable
    address: 0x2115
    entity_category: config
    optionsmap:
      "Disable": 0
      "Enable": 1

switch:
  - platform: modbus_controller
    modbus_controller_id: skyline
    name: "EPS Enabled"
    skip_updates: 10
    id: eps_enabled
    register_type: holding
    address: 0x211C
    entity_category: config

# Status LED
status_led:
  pin:
    number: GPIO2


  # Battery parameters
  #- platform: modbus_controller
  #  modbus_controller_id: skyline
  #  name: "BMS Comm Address"
  #  id: bms_comm_address
  #  register_type: holding
  #  address: 0x2111
  #  min_value: 1
  #  max_value: 255
  #  step: 1
  #  entity_category: config


#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Stop Discharge Voltage"
#    id: stop_discharge_voltage
#    register_type: holding
#    address: 0x2113
    #min_value: 420
    #max_value: 540
    #step: 1
#    unit_of_measurement: "V"
#    device_class: voltage
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Stop Charge Voltage"
#    id: stop_charge_voltage
#    register_type: holding
#    address: 0x2114
#    min_value: 540
#    max_value: 600
#    step: 1
#    unit_of_measurement: "V"
#    device_class: voltage
#    entity_category: config


  # Off-grid parameters
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Rated Output Voltage"
#    id: rated_output_voltage
#    skip_updates: 20
#    register_type: holding
#    address: 0x211D
#    unit_of_measurement: "V"
#    device_class: voltage
#    entity_category: diagnostic

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Rated Output Frequency"
#    id: rated_output_frequency
#    skip_updates: 20
#    register_type: holding
#    address: 0x211E
#    unit_of_measurement: "Hz"
#    device_class: frequency
#    entity_category: diagnostic

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Off-grid Start Battery Capacity"
#    id: offgrid_start_battery_capacity
#    register_type: holding
#    address: 0x211F
#    min_value: 10
#    max_value: 100
#    step: 1
#    unit_of_measurement: "%"
#    device_class: battery
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Maximum Discharge Current"
#    id: maximum_discharge_current
#    register_type: holding
#    address: 0x2120
#    min_value: 1
#    max_value: 200
#    step: 1
#    unit_of_measurement: "A"
#    device_class: current
#    entity_category: config
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Maximum Charger Current"
#    id: maximum_charger_current
#    register_type: holding
#    address: 0x2121
#    min_value: 1
#    max_value: 200
#    step: 1
#    unit_of_measurement: "A"
#    device_class: current
#    entity_category: config
#    filters:
#      - multiply: 0.01

  # Date/Time parameters
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Date Year"
#    id: date_year
#    register_type: holding
#    address: 0x3000
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Date Month"
#    id: date_month
#    register_type: holding
#    address: 0x3001
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Date Day"
#    id: date_day
#    register_type: holding
#    address: 0x3001
#    entity_category: config

  # Modbus and digital meter parameters
  #- platform: modbus_controller
  #  modbus_controller_id: skyline
  #  name: "Modbus Address"
  #  id: modbus_address
  #  register_type: holding
  #  address: 0x303E
  #  min_value: 1
  #  max_value: 247
  #  step: 1
  #  entity_category: config

 # - platform: modbus_controller
 #   modbus_controller_id: skyline
 #   name: "Digital Meter Modbus Address"
 #   id: digital_meter_modbus_address
 #   register_type: holding
 #   address: 0x30B0
 #   min_value: 1
 #   max_value: 255
 #   step: 1
 #   entity_category: config


  # Protection parameters
  #- platform: modbus_controller
  #  modbus_controller_id: skyline
  #  name: "Soft Start Time"
  #  id: soft_start_time
  #  register_type: holding
  #  address: 0x5000
  #  min_value: 10
  #  max_value: 600
  #  step: 1
  #  unit_of_measurement: "s"
  #  entity_category: config

 # - platform: modbus_controller
 #   modbus_controller_id: skyline
 #   name: "Reconnect Time"
 #   id: reconnect_time
 #   register_type: holding
 #   address: 0x5001
 #   min_value: 10
 #   max_value: 900
 #   step: 1
 #   unit_of_measurement: "s"
 #   entity_category: config

  # Grid protection limits
 # - platform: modbus_controller
 #   modbus_controller_id: skyline
 #   name: "Grid Frequency High Loss Level 1"
 #   id: grid_freq_high_loss_level_1
 #   register_type: holding
 #   address: 0x5002
 #   min_value: 5000
 #   max_value: 6000
 #   step: 1
 #   unit_of_measurement: "Hz"
 #   device_class: frequency
 #   entity_category: config
 #   filters:
 #     - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Grid Frequency Low Loss Level 1"
#    id: grid_freq_low_loss_level_1
#    register_type: holding
#    address: 0x5003
#    min_value: 4000
#    max_value: 5000
#    step: 1
#    unit_of_measurement: "Hz"
#    device_class: frequency
#    entity_category: config
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Grid Voltage High Loss Level 1"
#    id: grid_voltage_high_loss_level_1
#    register_type: holding
#    address: 0x5004
#    min_value: 2200
#    max_value: 3000
#    step: 1
#    unit_of_measurement: "V"
#    device_class: voltage
#    entity_category: config
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Grid Voltage Low Loss Level 1"
#    id: grid_voltage_low_loss_level_1
#    register_type: holding
#    address: 0x5005
#    min_value: 700
#    max_value: 2200
#    step: 1
#    unit_of_measurement: "V"
#    device_class: voltage
#    entity_category: config
#    filters:
#      - multiply: 0.1

# Additional protection parameters
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Derating Watt Percent"
#    id: derating_watt_percent
#    register_type: holding
#    address: 0x5104
#    min_value: 10
#    max_value: 100
#    step: 1
#    unit_of_measurement: "%"
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Unbalance Voltage Limit"
#    id: unbalance_voltage_limit
#    register_type: holding
#    address: 0x510F
#    min_value: 1
#    max_value: 20
#    step: 1
#    unit_of_measurement: "%"
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Ground Current Limit"
#    id: ground_current_limit
#    register_type: holding
#    address: 0x5110
#    min_value: 10
#    max_value: 300
#    step: 1
#    unit_of_measurement: "mA"
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Reactive Power Percent"
#    id: reactive_power_percent
#    register_type: holding
#    address: 0x5114
#    min_value: -60
#    max_value: 60
#    step: 1
#    unit_of_measurement: "%"
#    entity_category: config
#    value_type: S_WORD



#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Once/Everyday"
#    id: once_everyday
#    address: 0x2101
#    entity_category: config
#    optionsmap:
#      "Once": 0
#      "Everyday": 1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Battery Type Selection"
#    id: battery_type_selection
#    address: 0x2110
#    entity_category: config
#    optionsmap:
#      "Unavailable": 0
#      "Lead-Acid battery": 1
#      "PYLON Lithium-ion": 2
#      "Dyness Lithium-ion": 3
#      "Aobo Lithium-ion": 4
#      "UZ Lithium-ion": 5
#      "VestMoods Lithium-ion": 6
#      "XinYi Lithium-ion": 7

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Digital Meter Type"
#    id: digital_meter_type
#    address: 0x30B1
#    entity_category: config
#    optionsmap:
#      "Unknown": 0
#      "Gavazzi/EM340DINAV23XS1X": 1
#      "CHINT/DTSU666": 2
#      "Acrel/DTSF1352-C": 3
#      "Lovato/DMG210": 4
#      "G2000": 5
#      "Gavazzi/ET112": 6
#      "KSEM": 7
#      "CHINT/DDSU666": 8

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Digital Meter Power Direction"
#    id: digital_meter_power_direction
#    address: 0x30B2
#    entity_category: config
#    optionsmap:
#      "Positive": 0
#      "Negative": 1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Power Limit Function"
#    id: power_limit_function
#    address: 0x30B3
#    entity_category: config
#    optionsmap:
#      "Disable": 0
#      "Power limit by external device(G2000)": 1
#      "Power limit by PVI external CT sensor": 2
#      "Power limit by digital meter device": 3

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Power Limit CT Ratio"
#    id: power_limit_ct_ratio
#    address: 0x30B4
#    entity_category: config
#    optionsmap:
#      "Unknown": 0
#      "1000:1": 1
#      "2000:1": 2
#      "2500:1": 3
#      "3000:1": 4
#      "4000:1": 5
#      "5000:1": 6
#      "6000:1": 7
#      "10000:1": 8

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Power Limit Mode"
#    id: power_limit_mode
#    address: 0x30B5
#    entity_category: config
#    optionsmap:
#      "CT on Grid (Meter on Grid)": 0
#      "CT on Load (Meter on Load)": 1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Regulation Code"
#    id: regulation_code
#    address: 0x5101
#    entity_category: config
#    optionsmap:
#      "AU (Australia AS/NZS 4777.2/.3)": 1
#      "DE (Germany VDE 0126-1-1/A1)": 2
#      "TW (Taiwan TW GRID)": 3
#      "DE (Germany VDE-AR-N 4105)": 4
#      "JP (Japan JETGR0002-1-2.0)": 5
#      "IT (Italy CEI 0-21)": 6
#      "SE (Sweden SWEDEN Grid)": 7
#      "UK (British G98)": 8
#      "UL (USA UL)": 9
#      "TL (Thailand PEA)": 10
#      "SE (Sweden SWEDEN GRID) 2007": 11
#      "NL (Netherlands EN50549-1 2019)": 12
#      "TL (Thailand MEA)": 13
#      "CN (China NB/T 32004)": 14
#      "INDï¼India IEC61727ï¼": 15


#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Islanding Detection"
#    id: islanding_detection
#    register_type: holding
#    address: 0x510E
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV String Detection"
#    id: pv_string_detection
#    register_type: holding
#    address: 0x5111
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Low Voltage Through Detection"
#    id: low_voltage_through_detection
#    register_type: holding
#    address: 0x5112
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Adjust Resistance"
#    id: adjust_resistance
#    register_type: holding
#    address: 0x5115
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Insulation Resistor Detection"
#    id: insulation_resistor_detection
#    register_type: holding
#    address: 0x5117
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Ground Current Detection"
#    id: ground_current_detection
#    register_type: holding
#    address: 0x5118
#    entity_category: config

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Inverter Control"
#    id: inverter_control
#    register_type: holding
#    address: 0x6001
#    entity_category: config




  # PV Energy Today
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV Energy Today"
#    id: pv_energy_today
#    register_type: holding
#    address: 0x1025
#    register_count: 2
#    response_size: 4
#    unit_of_measurement: "kWh"
#    device_class: energy
#    state_class: total_increasing
#    accuracy_decimals: 2
#    value_type: U_DWORD
#    filters:
#      - multiply: 0.001

  # PV Energy Total
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV Energy Total"
#    id: pv_energy_total
#    register_type: holding
#    address: 0x101F
#    register_count: 2
#    response_size: 4
#    unit_of_measurement: "kWh"
#    device_class: energy
#    state_class: total_increasing
#    accuracy_decimals: 0
#    value_type: U_DWORD


#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "EPS Load L2"
#    id: eps_load_l2
#    register_type: holding
#    address: 0x1359
#    register_count: 2
#    response_size: 4
#    unit_of_measurement: "kW"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 2
#    value_type: S_DWORD
#    filters:
#      - multiply: 0.0001

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "EPS Load L3"
#    id: eps_load_l3
#    register_type: holding
#    address: 0x135E
#    register_count: 2
#    response_size: 4
#    unit_of_measurement: "kW"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 2
#    value_type: S_DWORD
#    filters:
#      - multiply: 0.0001



  # Battery Temperature (currently returns zero)
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Battery Temperature"
#    id: battery_temp
#    register_type: holding
#    address: 0x2001
#    unit_of_measurement: "Â°C"
#    device_class: temperature
#    state_class: measurement
#    accuracy_decimals: 0
#    value_type: S_WORD


  # Reactive Power
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Reactive Power"
#    id: reactive_power
#    register_type: holding
#    address: 0x1039
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "VAR"
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

  # Power Factor
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Power Factor"
#    id: power_factor
#    register_type: holding
#    address: 0x103D
#    value_type: S_WORD
#    state_class: measurement
#    accuracy_decimals: 3
#    filters:
#      - multiply: 0.001

  # PV4 sensors (if applicable)
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV4 Voltage"
#    id: pv4_voltage
#    register_type: holding
#    address: 0x103E
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV4 Current"
#    id: pv4_current
#    register_type: holding
#    address: 0x103F
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "MPPT4 Power"
#    id: mppt4_power
#    register_type: holding
#    address: 0x1040
#    register_count: 2
#    response_size: 4
#    value_type: U_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

  # Additional Grid sensors with correct addresses
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase R Grid Power"
#    id: phase_r_grid_power
#    register_type: holding
#    address: 0x1300
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase S Grid Power"
#    id: phase_s_grid_power
#    register_type: holding
#    address: 0x1302
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase T Grid Power"
#    id: phase_t_grid_power
#    register_type: holding
#    address: 0x1304
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

  # Load sensors
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase R Load Power"
#    id: phase_r_load_power
#    register_type: holding
#    address: 0x130A
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase S Load Power"
#    id: phase_s_load_power
#    register_type: holding
#    address: 0x130C
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase T Load Power"
#    id: phase_t_load_power
#    register_type: holding
#    address: 0x130E
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1


  # Missing Real-time Data Sensors from Protocol
  # Phase A/B/C Voltage (0x1001, 0x1006, 0x100B)
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase A Voltage"
#    id: phase_a_voltage
#    register_type: holding
#    address: 0x1001
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase A Current"
#    id: phase_a_current
#    register_type: holding
#    address: 0x1002
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase A Power"
#    id: phase_a_power
#    register_type: holding
#    address: 0x1003
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase A Frequency"
#    id: phase_a_frequency
#    register_type: holding
#    address: 0x1005
#    unit_of_measurement: "Hz"
#    device_class: frequency
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase B Voltage"
#    id: phase_b_voltage
#    register_type: holding
#    address: 0x1006
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase B Current"
#    id: phase_b_current
#    register_type: holding
#    address: 0x1007
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase B Power"
#    id: phase_b_power
#    register_type: holding
#    address: 0x1008
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase B Frequency"
#    id: phase_b_frequency
#    register_type: holding
#    address: 0x100A
#    unit_of_measurement: "Hz"
#    device_class: frequency
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase C Voltage"
#    id: phase_c_voltage
#    register_type: holding
#    address: 0x100B
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase C Current"
#    id: phase_c_current
#    register_type: holding
#    address: 0x100C
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase C Power"
#    id: phase_c_power
#    register_type: holding
#    address: 0x100D
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase C Frequency"
#    id: phase_c_frequency
#    register_type: holding
#    address: 0x100F
#    unit_of_measurement: "Hz"
#    device_class: frequency
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

  # Correct PV/MPPT sensors (updating existing ones with proper addresses)
  # PV1 = 0x1010, PV2 = 0x1014, PV3 = 0x1018, PV4 = 0x103E
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV1 Voltage"
#    id: pv1_voltage_correct
#    register_type: holding
#    address: 0x1010
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV1 Current"
#    id: pv1_current_correct
#    register_type: holding
#    address: 0x1011
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01



#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV2 Voltage"
#    id: pv2_voltage_correct
#    register_type: holding
#    address: 0x1014
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV2 Current"
#    id: pv2_current_correct
#    register_type: holding
#    address: 0x1015
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01


#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV3 Voltage"
#    id: pv3_voltage
#    register_type: holding
#    address: 0x1018
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "PV3 Current"
#    id: pv3_current
#    register_type: holding
#    address: 0x1019
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "MPPT3 Power"
#    id: mppt3_power
#    register_type: holding
#    address: 0x101A
#    register_count: 2
#    response_size: 4
#    value_type: U_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1



  # Error Code
 # - platform: modbus_controller
 #   modbus_controller_id: skyline
 #   name: "Error Code"
 #   id: error_code
 #   register_type: holding
 #   address: 0x101E
 #   register_count: 2
 #   response_size: 4
 #   value_type: U_DWORD
 #   state_class: measurement
 #   accuracy_decimals: 0



  # Additional Grid voltages and currents
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L1-N Grid Voltage"
#    id: l1_n_grid_voltage
#    register_type: holding
#    address: 0x131A
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L2-N Grid Voltage"
#    id: l2_n_grid_voltage
#    register_type: holding
#    address: 0x131B
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L3-N Grid Voltage"
#    id: l3_n_grid_voltage
#    register_type: holding
#    address: 0x131C
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

  # Grid currents (L1, L2, L3)
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L1 Grid Current"
#    id: l1_grid_current
#    register_type: holding
#    address: 0x131D
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L2 Grid Current"
#    id: l2_grid_current
#    register_type: holding
#    address: 0x131F
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L3 Grid Current"
#    id: l3_grid_current
#    register_type: holding
#    address: 0x1321
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

  # Load voltages (L1-N, L2-N, L3-N)
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L1-N Load Voltage"
#    id: l1_n_load_voltage
#    register_type: holding
#    address: 0x1323
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L2-N Load Voltage"
#    id: l2_n_load_voltage
#    register_type: holding
#    address: 0x1324
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L3-N Load Voltage"
#    id: l3_n_load_voltage
#    register_type: holding
#    address: 0x1325
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

  # Load currents (L1, L2, L3)
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L1 Load Current"
#    id: l1_load_current
#    register_type: holding
#    address: 0x1326
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L2 Load Current"
#    id: l2_load_current
#    register_type: holding
#    address: 0x1328
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "L3 Load Current"
#    id: l3_load_current
#    register_type: holding
#    address: 0x132A
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01


  # Additional EPS sensors
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase R EPS Voltage"
#    id: phase_r_eps_voltage
#    register_type: holding
#    address: 0x1350
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase R EPS Current"
#    id: phase_r_eps_current
#    register_type: holding
#    address: 0x1351
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase R EPS Power"
#    id: phase_r_eps_power
#    register_type: holding
#    address: 0x1353
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "EPS Frequency"
#    id: eps_frequency
#    register_type: holding
#    address: 0x1355
#    unit_of_measurement: "Hz"
#    device_class: frequency
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase S EPS Voltage"
#    id: phase_s_eps_voltage
#    register_type: holding
#    address: 0x1356
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase S EPS Current"
#    id: phase_s_eps_current
#    register_type: holding
#    address: 0x1357
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase S EPS Power"
#    id: phase_s_eps_power
#    register_type: holding
#    address: 0x1359
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase T EPS Voltage"
#    id: phase_t_eps_voltage
#    register_type: holding
#    address: 0x135B
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase T EPS Current"
#    id: phase_t_eps_current
#    register_type: holding
#    address: 0x135C
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.01

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Phase T EPS Power"
#    id: phase_t_eps_power
#    register_type: holding
#    address: 0x135E
#    register_count: 2
#    response_size: 4
#    value_type: S_DWORD
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 1
#    filters:
#      - multiply: 0.1



  # Error Message 4 (additional error code)
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Error Message 4"
#    id: error_message_4
#    register_type: holding
#    address: 0x2013
#    state_class: measurement
#    accuracy_decimals: 0


  # Power Sensors (0x1001-0x1040 range)
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Inverter Load L1"
#    id: inverter_load_l1
#    register_type: holding
#    address: 0x1001
#    unit_of_measurement: "kW"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.0001  # Convert to kW (registers are in 0.1W)

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Inverter Load L2"
#    id: inverter_load_l2
#    register_type: holding
#    address: 0x1006
#    unit_of_measurement: "kW"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.0001

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "Inverter Load L3"
#    id: inverter_load_l3
#    register_type: holding
#    address: 0x100B
#    unit_of_measurement: "kW"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 2
#    filters:
#      - multiply: 0.0001

  # MPPT1 Voltage and Current
# Returns zero
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "MPPT1 Voltage"
#    id: mppt1_voltage
#    register_type: holding
#    address: 0x100E
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 0
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "MPPT1 Current"
#    id: mppt1_current
#    register_type: holding
#    address: 0x100F
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 0
#    filters:
#      - multiply: 0.01

  # MPPT1 Power
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "MPPT1 Power"
#    id: mppt1_power
#    register_type: holding
#    address: 0x1010
#    register_count: 2
#    response_size: 4
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 0
#    value_type: U_DWORD
#    filters:
#      - multiply: 0.1

  # MPPT2 Voltage and Current
# Returns zero
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "MPPT2 Voltage"
#    id: mppt2_voltage
#    register_type: holding
#    address: 0x1012
#    unit_of_measurement: "V"
#    device_class: voltage
#    state_class: measurement
#    accuracy_decimals: 0
#    filters:
#      - multiply: 0.1

#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "MPPT2 Current"
#    id: mppt2_current
#    register_type: holding
#    address: 0x1013
#    unit_of_measurement: "A"
#    device_class: current
#    state_class: measurement
#    accuracy_decimals: 0
#    filters:
#      - multiply: 0.01

  # MPPT2 Power
#  - platform: modbus_controller
#    modbus_controller_id: skyline
#    name: "MPPT2 Power"
#    id: mppt2_power
#    register_type: holding
#    address: 0x1014
#    register_count: 2
#    response_size: 4
#    unit_of_measurement: "W"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 0
#    value_type: U_DWORD
#    filters:
#      - multiply: 0.1

  # Total PV Power (template sensor combining MPPT1 and MPPT2)
#  - platform: template
#    name: "PV Power"
#    id: pv_power
#    unit_of_measurement: "kW"
#    device_class: power
#    state_class: measurement
#    accuracy_decimals: 0
#    lambda: |-
#      return id(mppt1_power).state + id(mppt2_power).state;

